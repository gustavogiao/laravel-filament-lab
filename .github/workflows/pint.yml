name: Pint

on:
  workflow_call:
    inputs:
      PHP_VERSION:
        required: true
        type: string
      PHP_EXTENSIONS:
        required: true
        type: string
      PHP_INI_PROPERTIES:
        required: true
        type: string
      COMPOSER_FLAGS:
        required: true
        type: string
      CACHE_KEY:
        required: true
        type: string
      AUTO_FIX:
        required: false
        type: boolean
        default: false

permissions: {}

jobs:
  run:
    name: Run Pint Code Style Check
    runs-on: ubuntu-latest
    timeout-minutes: 5
    permissions:
      contents: write
      checks: write
    concurrency:
      group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}-pint
      cancel-in-progress: true

    steps:
      - name: Checkout code
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
        with:
          fetch-depth: 0
          persist-credentials: false
          ref: ${{ github.head_ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup PHP
        uses: shivammathur/setup-php@c541c155eee45413f5b09a52248675b1a2575231 # v2.31.1
        with:
          php-version: ${{ inputs.PHP_VERSION }}
          extensions: ${{ inputs.PHP_EXTENSIONS }}
          ini-values: ${{ inputs.PHP_INI_PROPERTIES }}
          coverage: none
          tools: composer:v2, cs2pr

      - name: Install composer dependencies
        uses: ramsey/composer-install@57532f8be5bda426838819c5ee9afb8af389d51a # v3.0.0
        with:
          composer-options: ${{ inputs.COMPOSER_FLAGS }}
          custom-cache-key: ${{ inputs.CACHE_KEY }}

      - name: Run Pint (Test Mode)
        if: ${{ !inputs.AUTO_FIX }}
        env:
          XDEBUG_MODE: off
        run: |
          vendor/bin/pint --test --parallel --format=checkstyle | cs2pr

      - name: Run Pint (Fix Mode)
        if: ${{ inputs.AUTO_FIX }}
        env:
          XDEBUG_MODE: off
        run: |
          vendor/bin/pint --parallel

      - name: Commit Pint Changes
        if: ${{ inputs.AUTO_FIX }}
        uses: stefanzweifel/git-auto-commit-action@8621497c8c39c72f3e2a999a26b4ca1b5058a842 # v5.0.1
        with:
          commit_message: 'style: fix code style with Pint'
          commit_options: '--no-verify'
          file_pattern: '*.php'
          commit_user_name: 'github-actions[bot]'
          commit_user_email: 'github-actions[bot]@users.noreply.github.com'

      - name: Output Pint Summary
        if: always()
        run: |
          echo "### Pint Code Style Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ inputs.AUTO_FIX }}" == "true" ]; then
            echo "Auto-fix mode enabled - Changes have been committed" >> $GITHUB_STEP_SUMMARY
          else
            echo "Test mode - No changes applied" >> $GITHUB_STEP_SUMMARY
          fi
